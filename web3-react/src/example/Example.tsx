import './Example.css'

import { useWeb3React } from '@web3-react/core'
import React, { useEffect, useState } from 'react'
import { ErrorBoundary, FallbackProps } from 'react-error-boundary'

import { ConnectionOptions } from '../libs/components/ConnectionOptions'
import { ConnectionType, switchNetwork } from '../libs/connections'
import { CHAIN_INFO, INPUT_CHAIN_URL } from '../libs/constants'

const FallbackComponent = ({ error }: FallbackProps) => {
  return (
    <div>
      <h1>An error occurred: {error.message}</h1>
      <p>Please reload the application</p>
    </div>
  )
}
// Listen for new blocks and update the wallet
const useOnBlockUpdated = (callback: (blockNumber: number) => void) => {
  const { provider } = useWeb3React()
  useEffect(() => {
    if (!provider) {
      return
    }
    const subscription = provider.on('block', callback)
    return () => {
      subscription.removeAllListeners()
    }
  })
}

const Example = () => {
  const { chainId, account, isActive, provider } = useWeb3React()
  const [blockNumber, setBlockNumber] = useState<number>(0)
  const [connectionType, setConnectionType] = useState<ConnectionType | null>(null)

  // Listen for new blocks and update the wallet
  useOnBlockUpdated((blockNumber: number) => {
    setBlockNumber(blockNumber)
  })

  const onAction = async () => {
    if (!provider) {
      return
    }
    console.log('onAction')
    console.log(provider.blockNumber)
    const data =
      '0x24856bc300000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000210040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000007600000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000001168862766400000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000684e7acab24000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000006600000007b02230091a7ed01230072f7006a004d60a8d4e71d599b8104250f00000000000000000000000000008322b84904ec0f21de280c2711e56ca8d49cb33300000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000005a0000000000000000000000000062f832261e769457d1d700cfea3bae6a43ccec2000000000000000000000000004c00500000ad104d7dbd00e3ae0a5c00560c000000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000063fc9e460000000000000000000000000000000000000000000000000000000063fdefc60000000000000000000000000000000000000000000000000000000000000000360c6ebe000000000000000000000000000000000000000059739e39ecb0317f0000007b02230091a7ed01230072f7006a004d60a8d4e71d599b8104250f0000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000dfb3f316da3d29a134f2d83f529c068a735de3c500000000000000000000000000000000000000000000000000000000000005bb00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101ebdc334300000000000000000000000000000000000000000000000000000101ebdc3343000000000000000000000000000062f832261e769457d1d700cfea3bae6a43ccec20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000164859cc08000000000000000000000000000000000000000000000000000000164859cc08000000000000000000000000000000a26b00c1f0df003000390027140000faa719000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000133800a660800000000000000000000000000000000000000000000000000000133800a66080000000000000000000000000011abd336d1a59671853cd6da1fb4527d79ba8f56000000000000000000000000000000000000000000000000000000000000004154f66d6e75930fd897f302713c043d049eb7d844509334c586cb4a3491447fe015c47e494a8ecfcbe5e03977e781dad11fb530a8378e20dcebb3734e553fa9801c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000'
    const tx = {
      data,
      to: '0xEf1c6E67703c7BD7107eed8303Fbe6EC2554BF6B',
      value: '4900000000000000',
    }

    const gasLimit = await provider.estimateGas(tx)
    await provider.getSigner().sendTransaction({ ...tx, gasLimit })
    console.log('gas', gasLimit)
  }

  return (
    <div className="App">
      <ErrorBoundary FallbackComponent={FallbackComponent}>
        {INPUT_CHAIN_URL === '' && <h2 className="error">Please set your RPC URL in config.ts</h2>}
        <h3>{`Block Number: ${blockNumber + 1}`}</h3>
        <ConnectionOptions
          activeConnectionType={connectionType}
          isConnectionActive={isActive}
          onActivate={setConnectionType}
          onDeactivate={setConnectionType}
        />
        <h3>{`ChainId: ${chainId}`}</h3>
        <h3>{`Connected Account: ${account}`}</h3>
        {Object.keys(CHAIN_INFO).map((chainId) => (
          <div key={chainId}>
            <button onClick={() => switchNetwork(parseInt(chainId), connectionType)}>
              {`Switch to ${CHAIN_INFO[chainId].label}`}
            </button>
          </div>
        ))}
        <button onClick={onAction}>Do Action</button>
      </ErrorBoundary>
    </div>
  )
}

export default Example
